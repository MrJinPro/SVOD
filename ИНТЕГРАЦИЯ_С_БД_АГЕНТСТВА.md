# Интеграция SVOD с БД охранного агентства

SVOD (Система Ведения Отчётов и Донесений) — веб‑панель, которая показывает оперативные события охраны, даёт поиск и строит отчёты.
Смысл SVOD появляется только при интеграции с «боевой» БД агентства: там лежат объекты (что охраняем), ответственные/контакты (кому звонить) и события (что произошло).
Без этих данных SVOD превращается в интерфейс без фактической картины.
Этот документ фиксирует, **какие таблицы и поля** читать, **как связывать сущности** и **как работать с архивами**, основываясь строго на DDL в репозитории.

> Важно про СУБД: в папке `sql/schemas/zeldor_agency` схемы в диалекте **Microsoft SQL Server (T‑SQL)** (Navicat export, `nvarchar`, `bit`, `IDENTITY`).
> В ТЗ упоминался MySQL/dbalarm20 — это расхождение нужно уточнить. Ниже описано то, что реально есть в схемах.

## Подключение к БД (IP/логин/пароль)

SVOD не должен «зашивать» реквизиты подключения в код. Практический минимум, который нужен сервису:
- `DB_HOST` — IP/hostname сервера БД
- `DB_PORT` — порт (для MS SQL Server обычно 1433)
- `DB_NAME` — имя базы (например, `Pult4DB`)
- `DB_USER` — пользователь
- `DB_PASSWORD` — пароль

Рекомендуемые варианты хранения настроек (любой один, по договорённости в проекте):
1) **Переменные окружения** (предпочтительно для production).
2) Локальный файл конфигурации (например, `config.ini` / `.env`) — **не коммитить** в репозиторий.
3) Для архивной БД (если она отдельная) — второй набор переменных (`ARCHIVE_DB_*`) или отдельное имя базы `ARCHIVE_DB_NAME`.

Пример строки подключения для SQLAlchemy (MS SQL + pymssql):
- `mssql+pymssql://<user>:<password>@<host>:<port>/<db_name>`

> Важно: в этом документе нет и не должно быть реальных IP/логинов/паролей. Здесь фиксируется только, **какие параметры нужны** и **где их задавать**.

### Текущие значения из `config.ini` (для стенда/разработки)

Ниже — значения, которые сейчас лежат в репозитории в `config.ini`. **Пароли намеренно замаскированы**, чтобы их нельзя было случайно «засветить» в документации/скриншотах.

**Боевая БД охраны (онлайн события/объекты):**
- `server`: `10.10.8.110`
- `database`: `Pult4DB`
- `user`: `sa`
- `password`: 1`

**Архивная БД (история/обработанные события):**
- `dsn_archive`: `DRIVER={SQL Server};SERVER=10.10.8.110;DATABASE=pult4db_archives;UID=sa;PWD=*** (скрыт);`

> В production эти реквизиты должны быть заданы отдельно (env/secret storage) и отличаться от dev.

## Про безопасность реквизитов

Чтобы не переживать за утечку данных доступа:
- SVOD разворачивается в **закрытой сети** (по контексту проекта), доступ снаружи отсутствует.
- Реальные реквизиты **не публикуются** в документации/коде и не должны попадать в git.
- В production реквизиты всё равно будут **заменены на боевые** (другой IP/пользователь/пароль), а локальные значения используются только для стенда/разработки.
- Даже в закрытой сети лучше держать пароли в окружении/секрет‑хранилище и выдавать минимальные права (read‑only на нужные таблицы), чтобы снизить риск случайных изменений.

---

## Какие сущности нужны

### Объект (Object)
Минимально, что можно собрать из схем:
- **id объекта**: `Panel.Panel_id` (varchar(15)) — «номер объекта».
- **название**: `Company.CompanyName` (nvarchar(150), nullable).
- **адрес**: `Company.address` (nvarchar(150), nullable).
- **клиент/владелец**: в схемах нет отдельной «таблицы клиентов» для SVOD; фактически «плательщик/компания» — это `Company` (PK `Company.ID`).
- **ответственные/контакты**: `ResponsiblesList` (ФИО/имя) + `ResponsibleTel` (телефоны) + связь с объектом через `Responsibles` (к какой панели/группе привязан ответственный).
- **статус/активность**:
  - выключен ли объект: `Panel.Disabled` (bit NOT NULL; описание: «1 — объект отключен»).
  - режим охраны по разделам: `Groups.IsOpen` (bit NULL; описание: «0 — под охраной; 1 — нет») + `Groups.TimeEvent` (datetime; «время прихода последнего события»).
- **примечания/тех.инфо** (если нужно на карточке): `Panel.Remarks`, `Panel.AdditionalTechnicalInformation`, `Panel.Partial`.

Рекомендуемый минимальный **Object DTO** для фронта (из реально доступного):
- `id: string` ← `Panel.Panel_id`
- `name: string | null` ← `Company.CompanyName`
- `address: string | null` ← `Company.address`
- `client: { id: number, name: string | null } | null` ← `Company.ID`, `Company.CompanyName` (если трактуем компанию как клиента)
- `responsibles: Array<{ id: number, name: string, phones: string[], order: number | null, group: number | null }>`
  - `id/name` из `ResponsiblesList`
  - `phones` из `ResponsibleTel.PhoneNo`
  - `order` из `Responsibles.Responsible_Number` (порядковый номер ответственного)
  - `group` из `Responsibles.Group_` (раздел объекта)
- `status: { disabled: boolean, groups?: Array<{ group: number, isOpen: boolean | null, timeEvent: string | null, name: string }> }`

### Событие (Event)
Согласно доступным схемам есть два источника:
1) **Свежие события (оперативные)**: `dbo.EventsSendLog` (Pult4DB)
2) **Архив событий (обработанные/история)**: таблицы вида `dbo.archiveYYYYMMDD`/`dbo.eventserviceYYYYMMDD` (в репозитории показан пример за месяц: `archive20260101`, `eventservice20260101`)

Минимальный **Event DTO** (что реально есть в DDL):
- `id: number`
  - для свежих: `EventsSendLog.log_id`
  - для архива: `archiveYYYY....Event_id`
- `object_id: string | null` ← `Panel_id` (varchar(15), nullable в логах/архиве)
- `group: number | null` ← `Group_`
- `zone: number | null` ← `Zone`
- `code: string | null` ← `Code` (varchar(6))
- `timestamp: string | null`
  - свежие: `DateTimeRecived` или `DateTimeSend` или `TimePutWebServerEvent` (все `datetime`, nullable)
  - архив: `TimeEvent` (datetime, nullable)
- `text: string | null` ← `TextSMS` (только в `EventsSendLog`) или `Result_Text`/`MeterCount` (в архиве)
- `processed/status`:
  - в `EventsSendLog`: `result` (tinyint, nullable) — интерпретация не описана в DDL.
  - в архиве: `StateEvent` (smallint, nullable), `ResultID` (int, nullable), `Result_Text`.
- `source`:
  - свежие: условно `EventsSendLog.LogType_id` + `AddressRemotePult` (если нужно) 
  - архив/сервис: `eventserviceYYYY..NameState`, `PersonName`, `GrResponseName`.

### Связи (object ↔ event)
Ключевая связка в схемах — по полю **`Panel_id`**:
- объект: `Panel.Panel_id` (PK)
- событие свежее: `EventsSendLog.Panel_id` (nullable)
- событие архивное: `archiveYYYY..Panel_id` (nullable)

Промежуточные сущности:
- `Groups` — «разделы/секции объекта», PK: (`Panel_id`, `Group_`).
- `Responsibles` — связь «объект/раздел ↔ ответственный», содержит (`panel_id`, `Group_`, `ResponsiblesList_id`) и `Responsible_Number`.
- `ResponsiblesList` — карточка ответственного (ФИО/адрес).
- `ResponsibleTel` — телефоны ответственного.

---

## Где в БД это лежит (таблицы и поля)

Ниже — только то, что есть в DDL в `sql/schemas/zeldor_agency/*`.

### Объекты

#### `dbo.Panel`
Назначение: базовая сущность «объект/панель охранной сигнализации».

Ключевые поля:
- PK: `Panel_id varchar(15) NOT NULL` (номер объекта)
- `Disabled bit NOT NULL` (1 — отключён)
- `CreateDate datetime NULL` (DEFAULT `getdate()`)
- `Remarks nvarchar(100) NULL`
- `AdditionalTechnicalInformation nvarchar(2000) NULL`
- `Latitude varchar(20) NULL`, `Longtitude varchar(20) NULL`
- `ObjectID int IDENTITY NOT NULL` (в DDL есть, но PK не объявлен на нём)

Индексы/уникальности: в показанном фрагменте DDL индексы не перечислены (кроме PK по `Panel_id`).

#### `dbo.Company`
Назначение: «компания/плательщик/карточка объекта» (в расширенном свойстве таблицы — «Плательщик»).

Ключевые поля:
- PK: `ID int IDENTITY NOT NULL`
- `CompanyName nvarchar(150) NULL`
- `address nvarchar(150) NULL`
- `Telephones nvarchar(100) NULL`
- `Memo nvarchar(max) NULL`
- `LastEditDate datetime NULL`

FK (есть в DDL, но это внешние справочники вне данного набора схем):
- `ServiceID -> ServiceOrganization.ID`
- `CustomerID -> Customers.ID`
- `TypeID -> CompanyType.ID`

#### `dbo.Groups`
Назначение: разделы/секции объекта + текущий режим охраны.

Ключевые поля:
- PK: (`Panel_id varchar(15)`, `Group_ int`)
- FK: `Panel_id -> Panel.Panel_id` (CASCADE)
- FK: `CompanyID -> Company.ID`
- `Message nvarchar(100) NOT NULL` (название/описание раздела)
- `IsOpen bit NULL` (0 — под охраной; 1 — нет)
- `TimeEvent datetime NULL` (время последнего события)
- `typeSchedule int NULL` (описание типов расписаний есть в extended property)

Индексы/уникальности: в DDL не перечислены отдельные индексы, кроме PK.

### Ответственные/контакты

#### `dbo.Responsibles`
Назначение: связь «объект/раздел ↔ ответственный», плюс порядок ответственных.

Ключевые поля:
- PK: `Responsible_id int IDENTITY NOT NULL`
- FK: (`panel_id`, `Group_`) -> `Groups(Panel_id, Group_)` (CASCADE)
- FK: `ResponsiblesList_id -> ResponsiblesList.ResponsiblesList_id` (CASCADE)
- `Responsible_Number int NOT NULL` (порядковый номер ответственного)

Индексы/уникальности:
- `IX_Responsibles_PanelID_Group` (`panel_id`, `Group_`)
- `IX_Responsibles_ResponsiblesList_id` (`ResponsiblesList_id`)
- уникальный ключ `UQ_Responsibles_List_Object` (`panel_id`, `Group_`, `ResponsiblesList_id`)

#### `dbo.ResponsiblesList`
Назначение: карточка ответственного.

Ключевые поля:
- PK: `ResponsiblesList_id int IDENTITY NOT NULL`
- `Responsible_Name nvarchar(100) NOT NULL`
- `Responsible_Address nvarchar(500) NULL`

#### `dbo.ResponsibleTel`
Назначение: телефоны ответственных.

Ключевые поля:
- PK: `ResponsibleTel_id int IDENTITY NOT NULL`
- `PhoneNo varchar(25) NOT NULL`
- FK: `ResponsiblesList_id -> ResponsiblesList.ResponsiblesList_id` (CASCADE)
- FK: `TypeTel_id -> ResponsibleTypeTel.TypeTel_id` (справочник не в этом наборе схем)

Индексы:
- `IX_ResponsibleTel_ResponsiblesList_id` (`ResponsiblesList_id`)
- `IX_ResponsibleTel_PhoneNo` (`PhoneNo`)

### События (свежие)

#### `dbo.EventsSendLog`
Назначение (по README): «лог отправленных событий» (используется триггером push-уведомлений).

Ключевые поля:
- PK: `log_id int IDENTITY NOT NULL`
- `Panel_id varchar(15) NULL`
- `Group_ int NULL`
- `Zone int NULL`
- `Code varchar(6) NULL`
- `DateTimeSend datetime NULL`
- `DateTimeRecived datetime NULL`
- `TimePutWebServerEvent datetime NULL`
- `TextSMS nvarchar(1000) NULL`
- `result tinyint NULL` (значения не описаны в DDL)
- `LogType_id int NOT NULL`

Индексы/уникальности: в DDL — только PK по `log_id`.

Что требует JOIN:
- `Panel_id` -> `Panel`/`Groups`/`Company` для получения названия/адреса объекта.

---

## Архив обработанных событий (archiveYYYYMMDD / eventserviceYYYYMMDD)

### Как устроено разбиение по датам
По примеру в схемах:
- архивная таблица: `dbo.archive20260101`
- сервисная таблица: `dbo.eventservice20260101`

Несмотря на маску из ТЗ `YYYYMMDD`, по DDL видно, что это **месячные партиции**:
- имя заканчивается на `01` (первое число месяца)
- есть CHECK constraint по `Date_Key` в диапазоне `20260101..20260131`

То есть фактическая логика: `archiveYYYYMM01` / `eventserviceYYYYMM01` и внутри хранится месяц.

### Схема архива (пример: `dbo.archive20260101`)
Минимальные поля:
- PK: `Event_id int NOT NULL`
- `Date_Key int NOT NULL` (формат YYYYMMDD, хранится как int)
- `Panel_id varchar(15) NULL` (object_id)
- `Group_ int NULL`
- `Zone int NULL`
- `Code varchar(6) NULL`
- `TimeEvent datetime NULL` (timestamp события)
- `StateEvent smallint NULL` (статус/состояние события; значения не описаны)
- `Result_Text nvarchar(800) NULL` (результат/описание)
- дополнительные: `Phone`, `MeterCount`, `DeviceEventTime`, `ResultID`, `BitMask`, `Event_Parent_id`.

Индексы:
- `archive20260101_date_key_Panel_id_TimeEvent` (`Date_Key`, `Panel_id`, `TimeEvent`)
- `IX_Linearchive20260101` (`Panel_id`, `Date_Key`, `Line`) INCLUDE (`Code`)

### Схема eventservice (пример: `dbo.eventservice20260101`)
Назначение: действия/обработка события (кто/когда/какое состояние присвоил).

Минимальные поля:
- PK: `Service_id int IDENTITY NOT NULL`
- FK: `Event_id int NOT NULL` -> `archive20260101.Event_id`
- `OperationTime datetime NOT NULL` (timestamp операции)
- `Date_Key int NOT NULL`
- `NameState nvarchar(60) NULL` (название состояния)
- `PersonName nvarchar(200) NULL` (кто обработал)
- `GrResponseName nvarchar(100) NULL`

Индекс:
- `IX_eventservice20260101_ev_id_dt` (`Event_id`, `Date_Key`)

### Одинаковая ли схема у разных дат
В репозитории есть DDL только для конкретного месяца (`20260101`).
По самому подходу (имя таблицы + CHECK на диапазон + индекс с именем, содержащим дату) видно, что таблицы **однотипные** и отличаются датой в имени и CHECK‑ограничении.
Чтобы подтвердить полностью, нужны DDL ещё 1–2 месяцев, либо запрос в `sys.tables` (но у агента нет доступа к БД).

### Как SVOD должен выбирать «события объекта за период»
Цель: **не сканировать все архивные таблицы**, а выбирать только нужные партиции.

Стратегия (месячные таблицы как в схемах):
1) По диапазону дат `[from, to]` вычислить список месяцев.
2) Для каждого месяца сформировать имя таблицы `archiveYYYYMM01` и собрать запрос через `UNION ALL`.
3) Внутри каждой партиции фильтровать по:
   - `Panel_id = :object_id`
   - `Date_Key BETWEEN :fromKey AND :toKey` (YYYYMMDD как int)
   - (опционально) `TimeEvent BETWEEN :fromDt AND :toDt`

Почему это быстро:
- есть индекс (`Date_Key`, `Panel_id`, `TimeEvent`), который поддерживает такие фильтры.

Если в конкретной инсталляции реально **дневные** таблицы `archiveYYYYMMDD`:
- алгоритм тот же, только список партиций — по дням.

### Рекомендации по упрощению выборок (VIEW/реестр партиций)
Вариант 1 (предпочтительно): **реестр партиций** в отдельной таблице, например `dbo.ArchivePartitions`:
- `table_name` (nvarchar)
- `kind` (archive/eventservice)
- `date_from` (int YYYYMMDD)
- `date_to` (int YYYYMMDD)

SVOD тогда:
- читает реестр → получает список таблиц для union → строит динамический SQL на стороне сервиса.

Вариант 2: VIEW на «последний месяц» (если нужен быстрый доступ к текущей истории).
Полный VIEW на «всё время» потребует обновления при появлении новых таблиц.

---

## Что именно будет читать SVOD (практично)

### Список объектов
Источник: `Panel` + `Groups` + `Company`.

Практический минимум:
- `Panel.Panel_id` (id)
- `Panel.Disabled` (активность)
- `Company.CompanyName`, `Company.address`
- текущий статус по разделам: `Groups.IsOpen`, `Groups.TimeEvent`, `Groups.Message`

Ключевой JOIN:
- `Groups.Panel_id = Panel.Panel_id`
- `Groups.CompanyID = Company.ID` (nullable)

### Карточка объекта
Источник: всё из списка + контакты.

Контакты:
- `Responsibles` фильтр по `panel_id = :object_id` (и при необходимости по `Group_`)
- `ResponsiblesList` по `Responsibles.ResponsiblesList_id`
- `ResponsibleTel` по `ResponsibleTel.ResponsiblesList_id`

Как отдать на фронт:
- сгруппировать телефоны по `ResponsiblesList_id`
- добавить `Responsibles.Responsible_Number` как «порядок/роль» (это единственное, что есть в схемах)

### События объекта

(а) Свежие:
- `EventsSendLog` по `Panel_id = :object_id`
- timestamp выбрать один и зафиксировать в контракте (без данных непонятно какой основной):
  - кандидат 1: `DateTimeRecived`
  - кандидат 2: `TimePutWebServerEvent`
  - кандидат 3: `DateTimeSend`

(б) Архивные:
- `archiveYYYYMM01` по `Panel_id = :object_id`
- плюс при необходимости «обработанность/оператор»: join на `eventserviceYYYYMM01` по `Event_id`

### Поиск
По схемам реально искать можно по:
- объектам: `Company.CompanyName`, `Company.address`, `Panel.Panel_id`, `Panel.Remarks`
- событиям:
  - свежие: `EventsSendLog.TextSMS`, `Code`
  - архив: `archiveYYYY..Result_Text`, `MeterCount`, `Code`

### Отчёт суточный
По схемам устойчивые поля времени:
- свежие: выбрать один timestamp из `EventsSendLog` и использовать везде одинаково
- архив: `archiveYYYY..Date_Key` (int YYYYMMDD) как опорное поле суток, а `TimeEvent` — для времени внутри суток

---

## Риски/неясности по схеме

1) Расхождение по СУБД: в ТЗ MySQL/dbalarm20, в репозитории — MS SQL Server (T‑SQL) и базы `Pult4DB`/`pult4db_archives`.
2) `EventsSendLog` по назначению — «лог отправленных событий», не гарантировано, что это полный поток событий охраны.
3) Неясна семантика `EventsSendLog.result`, `LogType_id`, а также `archive.StateEvent`, `ResultID`, `BitMask` — без справочников/данных нельзя корректно назвать статусы/серьёзность.
4) В архивах `Panel_id` nullable — нужно понять, бывают ли события без привязки к объекту.
5) Контакты: нет явного поля «роль/должность», кроме `Responsible_Number` (порядок). Как отличать «владелец/охранник/ответственный» — не следует выдумывать.

### Вопросы к владельцу БД (3–7)
1) Что является «источником истины» для оперативных событий: только `EventsSendLog` или есть другая таблица/представление полного потока?
2) Какой timestamp считать основным для «свежих событий»: `DateTimeRecived`, `TimePutWebServerEvent` или `DateTimeSend`?
3) Как интерпретировать `EventsSendLog.result` и `LogType_id` (список значений)?
4) Как интерпретировать `archive.StateEvent`, `ResultID`, `BitMask` (список значений)?
5) Архивы в проде — по дням (`archiveYYYYMMDD`) или по месяцам (`archiveYYYYMM01`)?
6) Можно ли считать `Company` «клиентом/плательщиком» для SVOD, или есть отдельная сущность «клиент» в других таблицах?

